import streamlit as st
import tensorflow as tf
import numpy as np
from PIL import Image
from tensorflow.keras.utilis import img_to_array


# --- ‡ßß. ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ---

# ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ
MODEL_PATH = 'dragon_fruit_disease_model.h5'
CLASSES_FILE = 'class_names.txt'
IMAGE_SIZE = (224, 224)

# ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶Ç (Caching) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ
def load_model_and_classes():
    try:
        # ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ: custom_objects ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá 'batch_shape' ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶è‡¶°‡¶º‡¶æ‡¶®‡ßã
        model = tf.keras.models.load_model(
            MODEL_PATH, 
            compile=False,
            custom_objects={'batch_shape': None} # <<< ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        )
        st.success(f"‡¶Æ‡¶°‡ßá‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {MODEL_PATH}")
    except Exception as e:
        st.error(f"‡¶Æ‡¶°‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: {e}")
        st.stop()
        
    try:
        # ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
        with open(CLASSES_FILE, 'r') as f:
            class_names = [line.strip() for line in f]
        st.success(f"‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: {CLASSES_FILE}")
    except Exception as e:
        st.error(f"‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: {e}")
        st.stop()
        
    return model, class_names

# --- ‡ß®. ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶¶‡ßç‡¶¨‡¶æ‡¶£‡ßÄ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---

def predict_image(model, img, class_names):
    # ‡¶õ‡¶¨‡¶ø‡¶ï‡ßá ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ
    img = img.resize(IMAGE_SIZE)
    # NumPy ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶§‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ
    img_array = img_to_array(img)
    # ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶°‡¶æ‡¶á‡¶Æ‡ßá‡¶®‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ (1, 224, 224, 3)
    img_array = np.expand_dims(img_array, axis=0)
    # 0-1 ‡¶∏‡ßç‡¶ï‡ßá‡¶≤‡¶ø‡¶Ç ‡¶ï‡¶∞‡¶æ 
    img_array /= 255.0

    # ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶¶‡ßç‡¶¨‡¶æ‡¶£‡ßÄ
    predictions = model.predict(img_array)
    score = predictions[0]
    
    # ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø‡¶§‡¶æ ‡¶ì ‡¶§‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
    predicted_index = np.argmax(score)
    predicted_class = class_names[predicted_index]
    confidence = score[predicted_index]

    return predicted_class, confidence

# --- ‡ß©. Streamlit UI ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ---

# ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
model, class_names = load_model_and_classes() 

st.set_page_config(
    page_title="‡¶°‡ßç‡¶∞‡¶æ‡¶ó‡¶® ‡¶´‡¶≤‡ßá‡¶∞ ‡¶∞‡ßã‡¶ó ‡¶∂‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£",
    layout="wide"
)

st.title("üêâ ‡¶°‡ßç‡¶∞‡¶æ‡¶ó‡¶® ‡¶´‡¶≤‡ßá‡¶∞ ‡¶∞‡ßã‡¶ó ‡¶∂‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£")
st.markdown("---")

# ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶â‡¶á‡¶ú‡ßá‡¶ü
uploaded_file = st.file_uploader(
    "‡¶∞‡ßã‡¶ó ‡¶®‡¶ø‡¶∞‡ßç‡¶£‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶°‡ßç‡¶∞‡¶æ‡¶ó‡¶® ‡¶´‡¶≤‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (.jpg, .png)", 
    type=['jpg', 'jpeg', 'png']
)

if uploaded_file is not None:
    # ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø PIL ‡¶á‡¶Æ‡ßá‡¶ú ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ñ‡ßã‡¶≤‡¶æ
    image_data = Image.open(uploaded_file)
    
    col1, col2 = st.columns([1, 1])

    with col1:
        st.header("‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶õ‡¶¨‡¶ø")
        st.image(image_data, caption='‡¶õ‡¶¨‡¶ø', use_column_width=True)
        st.markdown("---")
        
        # ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶¶‡ßç‡¶¨‡¶æ‡¶£‡ßÄ ‡¶¨‡¶æ‡¶ü‡¶®
        if st.button("‡¶∞‡ßã‡¶ó ‡¶®‡¶ø‡¶∞‡ßç‡¶£‡¶Ø‡¶º ‡¶ï‡¶∞‡ßÅ‡¶®"):
            with st.spinner("‡¶Æ‡¶°‡ßá‡¶≤ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶õ‡ßá..."):
                # ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶¶‡ßç‡¶¨‡¶æ‡¶£‡ßÄ ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
                predicted_class, confidence = predict_image(model, image_data, class_names)
            
            with col2:
                st.header("‡¶´‡¶≤‡¶æ‡¶´‡¶≤")
                st.markdown(f"### ‚ú® ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶∏‡¶ø‡¶§ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏: **{predicted_class}**")
                st.markdown(f"### üéØ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ: **{confidence*100:.2f}%**")
                
                # ‡¶´‡¶≤‡¶æ‡¶´‡¶≤‡ßá‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂
                st.markdown("---")
                if predicted_class == 'benign':
                    st.success("‚úÖ ‡¶è‡¶á ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø **‡¶∏‡ßÅ‡¶∏‡ßç‡¶• ‡¶¨‡¶æ ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶®‡ßç‡¶Ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ (Benign)** ‡¶¨‡¶≤‡ßá ‡¶Æ‡¶®‡ßá ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶ì ‡¶Ø‡¶§‡ßç‡¶® ‡¶®‡¶ø‡¶®‡•§")
                elif predicted_class == 'malignant':
                    st.error("üö® ‡¶è‡¶á ‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø **‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡¶∞ ‡¶∞‡ßã‡¶ó‡ßá ‡¶Ü‡¶ï‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§ (Malignant)** ‡¶¨‡¶≤‡ßá ‡¶Æ‡¶®‡ßá ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§")
                else:
                    st.warning("‚ùì ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶¨‡¶ø ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§")